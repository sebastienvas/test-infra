
bazel_spec: &bazel_spec
  containers:
  - image: gcr.io/istio-testing/prowbazel:0.4.11
    args:
    - "--repo=github.com/$(REPO_OWNER)/$(REPO_NAME)=$(PULL_REFS)"
    - "--clean"
    - "--timeout=20"
    # Bazel needs privileged mode in order to sandbox builds.
    securityContext:
      privileged: true
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "24Gi"
        cpu: "7000m"
  nodeSelector:
    testing: build-pool

branch_spec: &branch_spec
- "^master$"

presubmits:

  istio/test-infra:

  - name: test-infra-presubmit
    agent: kubernetes
    context: prow/test-infra-presubmit.sh
    always_run: true
    rerun_command: "/test test-infra-presubmit"
    trigger: "(?m)^/(retest|test (all|test-infra-presubmit))?,?(\\s+|$)"
    branches: *branch_spec
    labels:
      preset-service-account: "true"
      preset-bazel: "true"
    spec:
      <<: *bazel_spec


  - name: new-presubmit
    agent: kubernetes
    context: "prow: new-presubmit"
    skip_report: true
    always_run: true
    rerun_command: "/test test-infra-presubmit"
    path_alias: /go/src/istio.io/test-infra
    trigger: "(?m)^/(retest|test (all|test-infra-presubmit))?,?(\\s+|$)"
    decorate: true
    branches: *branch_spec
    labels:
      preset-service-account: "true"
      preset-bazel: "true"
    spec:
      containers:
      - image: gcr.io/istio-testing/istio-builder:podutils-test-01
        command:
        - entrypoints.sh
        - prow/new-test.sh
        # Bazel needs privileged mode in order to sandbox builds.
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "24Gi"
            cpu: "7000m"
      nodeSelector:
        testing: build-pool

postsubmits:

